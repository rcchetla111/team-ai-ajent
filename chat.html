<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent 365 - AI Meeting Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script
      src="https://unpkg.com/adaptivecards/dist/adaptivecards.min.js"
      crossorigin="anonymous"
    ></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .adaptive-card {
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
      }
      .chat-container::-webkit-scrollbar {
        width: 8px;
      }
      .chat-container::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      .chat-container::-webkit-scrollbar-thumb {
        background: #94a3b8;
        border-radius: 4px;
      }
      .typing-indicator {
        animation: pulse 1.5s ease-in-out infinite;
      }
      .auto-insights-status {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        margin-left: 10px;
        display: none;
      }
      .auto-insights-active {
        display: inline-block;
        animation: pulse 2s infinite;
      }
    </style>
  </head>
  <body
    class="bg-slate-100 flex flex-col items-center justify-center h-screen p-4"
  >
    <div
      class="w-full max-w-6xl mx-auto flex flex-col h-full bg-white rounded-2xl shadow-2xl"
    >
      <!-- Enhanced Header with Auto-Insights Status -->
      <div
        class="p-4 border-b border-slate-200 flex justify-between items-center"
      >
        <div class="flex items-center space-x-3">
          <div
            class="p-2 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 text-white"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2 2v10a2 2 0 002 2z"
              />
            </svg>
          </div>
          <div>
            <h1 class="text-lg font-bold text-slate-800">Agent 365</h1>
            <p class="text-sm text-slate-500">
              AI Meeting Assistant with Teams Integration
            </p>
          </div>
          <!-- Auto-Insights Status Indicator -->
          <div class="auto-insights-status" id="auto-insights-status">
            🤖 Auto-Insights Active
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <span
            id="api-status-indicator"
            class="h-3 w-3 rounded-full bg-yellow-400 animate-pulse"
            title="Checking API status..."
          ></span>
          <span id="api-status-text" class="text-sm text-slate-500"
            >Connecting...</span
          >
        </div>
      </div>

      <!-- Chat Messages -->
      <div
        id="chat-container"
        class="flex-1 p-6 overflow-y-auto chat-container"
      ></div>

      <!-- Enhanced Message Input -->
      <div class="p-4 border-t border-slate-200 bg-slate-50">
        <div class="flex flex-wrap gap-2 mb-3" id="quick-actions">
          <button
            onclick="sendQuickMessage('Create a meeting for tomorrow at 2pm with auto-insights')"
            class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs hover:bg-blue-200"
          >
            🤖 Smart Meeting
          </button>
          <button
            onclick="sendQuickMessage('Send message to Rohit')"
            class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs hover:bg-green-200"
          >
            💬 Send Message
          </button>
          <button
            onclick="sendQuickMessage('Show my recent meetings with insights')"
            class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs hover:bg-purple-200"
          >
            📊 My Meetings
          </button>
          <button
            onclick="sendQuickMessage('Find team members')"
            class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs hover:bg-orange-200"
          >
            👥 Find People
          </button>
          <button
            onclick="sendQuickMessage('Join agent to my latest meeting')"
            class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs hover:bg-indigo-200"
          >
            🚀 Auto-Join Agent
          </button>
        </div>
        <form id="chat-form" class="flex items-center space-x-3">
          <input
            type="text"
            id="message-input"
            class="flex-1 block w-full px-4 py-3 bg-white border border-slate-300 rounded-xl text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 disabled:bg-slate-100"
            placeholder="Create a smart meeting with auto-insights..."
            autocomplete="off"
            disabled
          />
          <button
            type="submit"
            id="send-button"
            class="p-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl hover:from-blue-600 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-slate-300"
            disabled
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
              />
            </svg>
          </button>
        </form>
      </div>
    </div>

    <script>
      const ui = {
        chatContainer: document.getElementById("chat-container"),
        chatForm: document.getElementById("chat-form"),
        messageInput: document.getElementById("message-input"),
        sendButton: document.getElementById("send-button"),
        apiStatusIndicator: document.getElementById("api-status-indicator"),
        apiStatusText: document.getElementById("api-status-text"),
        autoInsightsStatus: document.getElementById("auto-insights-status"),
      };

      const API_BASE_URL = "http://localhost:5000/api";
      const GEMINI_API_KEY = "";
      const GEMINI_MODEL = "gemini-1.5-flash-latest";
      let conversationHistory = [];
      let lastCreatedMeeting = null;
      let autoInsightsActive = false;

      // ====================================================================
      // --- ENHANCED AGENT TOOLS WITH AUTO-INSIGHTS ---
      // ====================================================================

      const agentTools = [
        {
          name: "create_meeting",
          description:
            "Creates a new meeting with optional attendees and auto-insights",
          parameters: {
            type: "object",
            properties: {
              subject: { type: "string" },
              date: {
                type: "string",
                description: "Raw date like 'today', 'tomorrow', 'August 10th'",
              },
              time: {
                type: "string",
                description: "Raw time like '10pm', '2:30 PM'",
              },
              attendees: {
                type: "array",
                items: { type: "string" },
                description: "Names or emails of attendees",
              },
              sendInvites: {
                type: "boolean",
                description: "Whether to send invite messages",
              },
              enableAutoInsights: {
                type: "boolean",
                description: "Enable automatic insights and monitoring",
              },
            },
            required: ["subject", "date", "time"],
          },
        },
        {
          name: "join_meeting",
          description: "Manually join agent to a meeting for auto-insights",
          parameters: {
            type: "object",
            properties: {
              meetingSubject: {
                type: "string",
                description: "Subject of the meeting to join",
              },
            },
            required: ["meetingSubject"],
          },
        },
        {
          name: "leave_meeting",
          description: "Leave agent from a meeting and get final summary",
          parameters: {
            type: "object",
            properties: {
              meetingSubject: {
                type: "string",
                description: "Subject of the meeting to leave",
              },
            },
            required: ["meetingSubject"],
          },
        },
        {
          name: "send_message",
          description: "Sends a message to a team member by name or email",
          parameters: {
            type: "object",
            properties: {
              recipient: {
                type: "string",
                description: "Name or email of recipient",
              },
              message: {
                type: "string",
                description: "Message content to send",
              },
            },
            required: ["recipient", "message"],
          },
        },
        {
          name: "find_people",
          description: "Searches for team members by name",
          parameters: {
            type: "object",
            properties: {
              searchTerm: { type: "string", description: "Name to search for" },
            },
            required: ["searchTerm"],
          },
        },
        {
          name: "get_meetings",
          description: "Lists user's recent meetings with auto-insights status",
          parameters: {
            type: "object",
            properties: {
              limit: {
                type: "number",
                description: "Number of meetings to show",
              },
            },
          },
        },
        {
          name: "get_meeting_analysis",
          description: "Gets chat analysis for a specific meeting",
          parameters: {
            type: "object",
            properties: {
              meetingSubject: {
                type: "string",
                description: "Subject of the meeting to analyze",
              },
            },
            required: ["meetingSubject"],
          },
        },
        {
          name: "get_meeting_summary",
          description: "Generates or retrieves a meeting summary",
          parameters: {
            type: "object",
            properties: {
              meetingSubject: {
                type: "string",
                description: "Subject of the meeting to summarize",
              },
            },
            required: ["meetingSubject"],
          },
        },
        {
          name: "get_team_members",
          description: "Lists all team members in the organization",
          parameters: {
            type: "object",
            properties: {
              limit: {
                type: "number",
                description: "Max number of members to show",
              },
            },
          },
        },
        {
          name: "answer_general_question",
          description: "Responds to greetings or general questions",
          parameters: {
            type: "object",
            properties: {
              responseText: { type: "string" },
            },
            required: ["responseText"],
          },
        },
      ];

      // ====================================================================
      // --- ENHANCED AGENT PROMPT WITH AUTO-INSIGHTS ---
      // ====================================================================

      function getAgentPrompt(history, message) {
        const historyString = history
          .map((turn) => `${turn.role}: ${turn.message}`)
          .join("\n");
        const currentDate = new Date().toLocaleDateString();
        const currentTime = new Date().toLocaleTimeString();

        return `You are Agent 365, an advanced AI meeting assistant with full Teams integration and AUTO-INSIGHTS capabilities. You can create meetings, send messages, find people, analyze meetings, and provide real-time insights.

**Context Information:**
- Current Date: ${currentDate}
- Current Time: ${currentTime}
- You have access to real Teams integration
- AUTO-INSIGHTS: Can automatically join meetings and provide live insights
- You can find real team members and send them messages
- You can create meetings with real attendees and auto-insights enabled

**Conversation History:**
${historyString}

**Current User Request:** "${message}"

**Your Enhanced Capabilities:**
1. **create_meeting**: Create meetings with auto-insights enabled by default
2. **join_meeting**: Manually join agent to meetings for live monitoring
3. **leave_meeting**: Leave meetings and generate final summaries
4. **send_message**: Send messages/emails to team members by name
5. **find_people**: Search for team members in the organization
6. **get_meetings**: Show user's recent meetings with insights status
7. **get_meeting_analysis**: Analyze chat from meetings with AI
8. **get_meeting_summary**: Generate meeting summaries with action items
9. **get_team_members**: List all team members

**Auto-Insights Features:**
- Real-time action item detection
- Decision tracking and notifications
- Question pattern analysis
- Participant engagement metrics
- Automatic email alerts to attendees
- Final comprehensive summaries

**Instructions:**
1. **Enable Auto-Insights by Default**: Always suggest enabling auto-insights for meetings
2. **Extract Raw Data**: For dates/times, extract as-is ("tomorrow", "3pm") - don't calculate
3. **Be Proactive**: Suggest joining agent to meetings for insights
4. **Use Names**: Accept both names ("John Smith") and emails ("john@company.com")
5. **Smart Defaults**: For meetings, default to 30 minutes, auto-join agent, send invites, enable auto-insights

**Response Format**: Respond ONLY with valid JSON: { "tool_name": "...", "parameters": { ... } }

**Examples:**
- "Schedule a meeting with Sarah tomorrow at 2pm" → create_meeting with attendees: ["Sarah"], enableAutoInsights: true
- "Join agent to my morning standup" → join_meeting
- "Leave the current meeting and get summary" → leave_meeting
- "Send message to John saying the meeting is moved" → send_message
- "Find team members named Mike" → find_people
- "Show my recent meetings with insights" → get_meetings
- "Analyze the chat from yesterday's standup" → get_meeting_analysis

Choose the best tool and extract the raw parameters:`;
      }

      async function getAgentAction(message) {
        const prompt = getAgentPrompt(conversationHistory, message);
        console.log("🤖 Agent Prompt:", prompt);

        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }],
              generationConfig: {
                temperature: 0.1,
                maxOutputTokens: 1000,
              },
            }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              `Gemini API request failed: ${errorData.error.message}`
            );
          }

          const data = await response.json();
          if (!data.candidates || !data.candidates[0].content.parts[0].text) {
            throw new Error("Invalid response structure from Gemini API.");
          }

          const rawText = data.candidates[0].content.parts[0].text;
          console.log("🤖 Raw AI Response:", rawText);

          const jsonString = rawText.replace(/```json|```/g, "").trim();
          const action = JSON.parse(jsonString);

          console.log("🤖 Parsed Action:", action);
          return action;
        } catch (error) {
          console.error("getAgentAction failed:", error);
          return {
            tool_name: "answer_general_question",
            parameters: {
              responseText: `I'm having trouble understanding that request. Could you please rephrase it? Error: ${error.message}`,
            },
          };
        }
      }

      // ====================================================================
      // --- ENHANCED TOOL HANDLERS WITH AUTO-INSIGHTS ---
      // ====================================================================

      async function handleUserMessage(message) {
        addMessage(message, "user");
        conversationHistory.push({ role: "user", message: message });
        showLoading(true);

        const action = await getAgentAction(message);
        if (!action || !action.tool_name) {
          addMessage("I'm not sure how to proceed with that request.", "bot");
          showLoading(false);
          return;
        }

        let agentResponseText = "";
        try {
          switch (action.tool_name) {
            case "create_meeting":
              agentResponseText = await handleCreateMeeting(action.parameters);
              break;
            case "join_meeting":
              agentResponseText = await handleJoinMeeting(action.parameters);
              break;
            case "leave_meeting":
              agentResponseText = await handleLeaveMeeting(action.parameters);
              break;
            case "send_message":
              agentResponseText = await handleSendMessage(action.parameters);
              break;
            case "find_people":
              agentResponseText = await handleFindPeople(action.parameters);
              break;
            case "get_meetings":
              agentResponseText = await handleGetMeetings(action.parameters);
              break;
            case "get_meeting_analysis":
              agentResponseText = await handleGetMeetingAnalysis(
                action.parameters
              );
              break;
            case "get_meeting_summary":
              agentResponseText = await handleGetMeetingSummary(
                action.parameters
              );
              break;
            case "get_team_members":
              agentResponseText = await handleGetTeamMembers(action.parameters);
              break;
            case "answer_general_question":
              agentResponseText = action.parameters.responseText;
              addMessage(agentResponseText, "bot");
              break;
            default:
              agentResponseText = `I don't know how to handle: ${action.tool_name}`;
              addMessage(agentResponseText, "bot");
          }
        } catch (error) {
          console.error("Tool execution error:", error);
          agentResponseText = `Sorry, I encountered an error: ${error.message}`;
          addMessage(agentResponseText, "bot");
        }

        conversationHistory.push({ role: "agent", message: agentResponseText });
        if (conversationHistory.length > 10) {
          conversationHistory = conversationHistory.slice(-10);
        }
        showLoading(false);
      }

      // Tool implementation functions
      function parseDateTime(dateStr, timeStr) {
        const now = new Date();
        let meetingDate = new Date();
        const timeLower = (timeStr || "").toLowerCase();
        const dateLower = (dateStr || "").toLowerCase();

        // Handle relative times like "5 minutes from now"
        if (timeLower.includes("minute")) {
          const match = timeLower.match(/(\d+)/);
          if (match) {
            meetingDate.setMinutes(now.getMinutes() + parseInt(match[1], 10));
            return meetingDate.toISOString();
          }
        }

        // Handle date parsing
        if (dateLower.includes("tomorrow")) {
          meetingDate.setDate(now.getDate() + 1);
        } else if (dateLower && !dateLower.includes("today")) {
          let parsed = new Date(dateStr);
          if (!isNaN(parsed)) meetingDate = parsed;
        }

        // Handle time parsing
        if (timeStr) {
          const match = timeStr.match(/(\d{1,2}):?(\d{2})?\s*(am|pm)?/i);
          if (match) {
            let hours = parseInt(match[1], 10);
            const minutes = match[2] ? parseInt(match[2], 10) : 0;
            const ampm = match[3] ? match[3].toLowerCase() : "";
            if (ampm === "pm" && hours < 12) hours += 12;
            if (ampm === "am" && hours === 12) hours = 0;
            meetingDate.setHours(hours, minutes, 0, 0);
          }
        }
        return meetingDate.toISOString();
      }

      // 🆕 ENHANCED: Create meeting with auto-insights enabled by default
      async function handleCreateMeeting(params) {
        try {
          const startTime = parseDateTime(params.date, params.time);
          const endTime = new Date(
            new Date(startTime).getTime() + 30 * 60000
          ).toISOString();

          const payload = {
            subject: params.subject,
            description: `${params.subject} - Created with auto-insights enabled`,
            startTime,
            endTime,
            attendeeNames: params.attendees || [],
            sendInviteMessages: params.sendInvites !== false,
            autoJoinAgent: true, // Always enable for auto-insights
            enableChatCapture: true, // Always enable for auto-insights
            enableAutoInsights: params.enableAutoInsights !== false, // Default to true
          };

          // Use the enhanced endpoint
          const response = await fetch(
            `${API_BASE_URL}/meetings/create-with-real-users`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            }
          );

          const data = await response.json();
          if (!response.ok)
            throw new Error(
              data.details || data.error || "Failed to create meeting"
            );

          lastCreatedMeeting = data.meeting;

          // Show auto-insights status
          showAutoInsightsStatus(true);

          addMessage(
            createEnhancedMeetingCard(data.meeting, data.realUserResolution),
            "bot",
            "card"
          );

          return `✅ Smart meeting created: "${params.subject}"
🤖 Auto-insights: ENABLED
📧 Attendees: ${data.realUserResolution?.usersResolved || 0} resolved
🔔 You'll receive real-time insights via email!`;
        } catch (error) {
          const msg = `Error creating meeting: ${error.message}`;
          addMessage(msg, "bot");
          return msg;
        }
      }

      // 🆕 NEW: Handle joining agent to meeting
      async function handleJoinMeeting(params) {
        try {
          const meeting = await findMeetingBySubject(params.meetingSubject);
          const response = await fetch(
            `${API_BASE_URL}/meetings/${meeting.meetingId}/join-agent`,
            {
              method: "POST",
            }
          );
          const data = await response.json();

          if (!response.ok)
            throw new Error(data.error || "Failed to join meeting");

          showAutoInsightsStatus(true);

          const msg = `🤖 Agent joined "${meeting.subject}"!

✅ Auto-insights activated
📊 Real-time monitoring started
📧 Insights will be sent to attendees
🔍 Chat analysis in progress

You'll receive welcome email and live insights!`;
          addMessage(msg, "bot");
          return msg;
        } catch (error) {
          const msg = `Error joining meeting: ${error.message}`;
          addMessage(msg, "bot");
          return msg;
        }
      }

      // 🆕 NEW: Handle leaving agent from meeting
      async function handleLeaveMeeting(params) {
        try {
          const meeting = await findMeetingBySubject(params.meetingSubject);
          const response = await fetch(
            `${API_BASE_URL}/meetings/${meeting.meetingId}/leave-agent`,
            {
              method: "POST",
            }
          );
          const data = await response.json();

          if (!response.ok)
            throw new Error(data.error || "Failed to leave meeting");

          showAutoInsightsStatus(false);

          const msg = `🏁 Agent left "${meeting.subject}"

📋 Final summary generated
📧 Comprehensive report sent to all attendees
📊 Meeting analytics completed
✅ Auto-insights session ended

Check your email for the detailed meeting summary!`;
          addMessage(msg, "bot");
          return msg;
        } catch (error) {
          const msg = `Error leaving meeting: ${error.message}`;
          addMessage(msg, "bot");
          return msg;
        }
      }

      async function handleSendMessage(params) {
        try {
          const response = await fetch(
            `${API_BASE_URL}/meetings/send-message-by-name`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                name: params.recipient,
                message: params.message,
              }),
            }
          );

          const data = await response.json();
          if (!response.ok)
            throw new Error(
              data.details || data.error || "Failed to send message"
            );

          const successMsg = `✅ Message sent to ${data.result.recipient.name} via email!`;
          addMessage(successMsg, "bot");
          return successMsg;
        } catch (error) {
          const msg = `Error sending message: ${error.message}`;
          addMessage(msg, "bot");
          return msg;
        }
      }

      async function handleFindPeople(params) {
        try {
          const response = await fetch(
            `${API_BASE_URL}/meetings/team-members/search?q=${encodeURIComponent(
              params.searchTerm
            )}`
          );
          const data = await response.json();

          if (!response.ok)
            throw new Error(
              data.details || data.error || "Failed to search people"
            );

          let resultMsg = `🔍 Found ${data.found} team members matching "${params.searchTerm}":\n\n`;
          data.users.forEach((user) => {
            resultMsg += `👤 **${user.name}**\n`;
            resultMsg += `📧 ${user.email}\n`;
            if (user.jobTitle) resultMsg += `💼 ${user.jobTitle}\n`;
            resultMsg += `\n`;
          });

          addMessage(resultMsg, "bot");
          return resultMsg;
        } catch (error) {
          const msg = `Error finding people: ${error.message}`;
          addMessage(msg, "bot");
          return msg;
        }
      }

      // 🆕 ENHANCED: Show meetings with auto-insights status
      async function handleGetMeetings(params) {
        try {
          const limit = params.limit || 10;
          const response = await fetch(
            `${API_BASE_URL}/meetings?limit=${limit}`
          );
          const data = await response.json();

          if (!response.ok)
            throw new Error(data.error || "Failed to get meetings");

          if (data.meetings.length === 0) {
            const msg =
              "📅 You don't have any recent meetings. Create one with auto-insights!";
            addMessage(msg, "bot");
            return msg;
          }

          let resultMsg = `📅 **Your recent meetings with auto-insights status:**\n\n`;
          data.meetings.slice(0, 5).forEach((meeting) => {
            const date = new Date(meeting.startTime).toLocaleString();
            const insightsStatus = meeting.agentAttended
              ? "🤖 Auto-insights enabled"
              : "👤 Manual only";
            resultMsg += `🟢 **${meeting.subject}**\n`;
            resultMsg += `⏰ ${date}\n`;
            resultMsg += `👥 ${meeting.attendees?.length || 0} attendees\n`;
            resultMsg += `${insightsStatus}\n`;
            resultMsg += `📊 Status: ${meeting.status}\n\n`;
          });

          addMessage(resultMsg, "bot");
          return resultMsg;
        } catch (error) {
          const msg = `Error getting meetings: ${error.message}`;
          addMessage(msg, "bot");
          return msg;
        }
      }

      async function handleGetMeetingAnalysis(params) {
        try {
          const meeting = await findMeetingBySubject(params.meetingSubject);
          const response = await fetch(
            `${API_BASE_URL}/meetings/${meeting.meetingId}/chat-analysis`
          );
          const data = await response.json();

          if (!response.ok)
            throw new Error(data.error || "Failed to get analysis");

          const analysis = data.analysis;
          let resultMsg = `📊 **Auto-Insights Analysis for "${meeting.subject}"**\n\n`;
          resultMsg += `💬 Total Messages: ${analysis.totalMessages}\n`;
          resultMsg += `❓ Questions: ${analysis.categorizedCounts.questions}\n`;
          resultMsg += `✅ Action Items: ${analysis.categorizedCounts.actionItems}\n`;
          resultMsg += `🎯 Decisions: ${analysis.categorizedCounts.decisions}\n\n`;

          if (analysis.keyInsights.mostActiveParticipant) {
            resultMsg += `🏆 Most Active: ${analysis.keyInsights.mostActiveParticipant}\n`;
          }

          resultMsg += `\n🤖 This analysis was generated by auto-insights AI!`;

          addMessage(resultMsg, "bot");
          return resultMsg;
        } catch (error) {
          const msg = `Error getting meeting analysis: ${error.message}`;
          addMessage(msg, "bot");
          return msg;
        }
      }

      async function handleGetMeetingSummary(params) {
        try {
          const meeting = await findMeetingBySubject(params.meetingSubject);
          const response = await fetch(
            `${API_BASE_URL}/meetings/${meeting.meetingId}/summary`
          );
          const data = await response.json();

          if (!response.ok)
            throw new Error(data.error || "Failed to get summary");

          const summary = data.summary;
          let resultMsg = `📋 **AI-Generated Summary: "${meeting.subject}"**\n\n`;
          resultMsg += `📝 ${summary.executiveSummary}\n\n`;

          if (summary.actionItems && summary.actionItems.length > 0) {
            resultMsg += `✅ **Action Items (Auto-detected):**\n`;
            summary.actionItems.forEach((item) => {
              resultMsg += `• ${item.task} (${item.assignee})\n`;
            });
          }

          resultMsg += `\n🤖 Summary generated with auto-insights AI!`;

          addMessage(resultMsg, "bot");
          return resultMsg;
        } catch (error) {
          const msg = `Error getting meeting summary: ${error.message}`;
          addMessage(msg, "bot");
          return msg;
        }
      }

      async function handleGetTeamMembers(params) {
        try {
          const limit = params.limit || 20;
          const response = await fetch(
            `${API_BASE_URL}/meetings/team-members?limit=${limit}`
          );
          const data = await response.json();

          if (!response.ok)
            throw new Error(data.error || "Failed to get team members");

          let resultMsg = `👥 **Team Members** (${data.total} total):\n\n`;
          data.users.slice(0, 10).forEach((user) => {
            resultMsg += `👤 ${user.name}\n`;
            resultMsg += `📧 ${user.email}\n`;
            if (user.jobTitle) resultMsg += `💼 ${user.jobTitle}\n`;
            resultMsg += `\n`;
          });

          if (data.total > 10) {
            resultMsg += `... and ${data.total - 10} more members\n`;
          }

          addMessage(resultMsg, "bot");
          return resultMsg;
        } catch (error) {
          const msg = `Error getting team members: ${error.message}`;
          addMessage(msg, "bot");
          return msg;
        }
      }

      async function findMeetingBySubject(subject) {
        const listResponse = await fetch(`${API_BASE_URL}/meetings`);
        const listData = await listResponse.json();
        if (!listResponse.ok) throw new Error("Could not fetch meeting list.");

        const foundMeeting = listData.meetings
          .filter((m) =>
            m.subject.toLowerCase().includes(subject.toLowerCase())
          )
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];

        if (!foundMeeting)
          throw new Error(
            `I couldn't find a meeting with the subject "${subject}".`
          );
        return foundMeeting;
      }

      // ====================================================================
      // --- ENHANCED UI FUNCTIONS WITH AUTO-INSIGHTS ---
      // ====================================================================

      function sendQuickMessage(message) {
        ui.messageInput.value = message;
        handleUserMessage(message);
        ui.messageInput.value = "";
      }

      function showAutoInsightsStatus(active) {
        autoInsightsActive = active;
        if (active) {
          ui.autoInsightsStatus.classList.add("auto-insights-active");
          ui.autoInsightsStatus.textContent = "🤖 Auto-Insights Active";
        } else {
          ui.autoInsightsStatus.classList.remove("auto-insights-active");
          ui.autoInsightsStatus.textContent = "🤖 Auto-Insights Inactive";
        }
      }

      function showLoading(show = true) {
        const existing = document.getElementById("loading-indicator");
        if (existing) existing.remove();

        if (show) {
          const loadingWrapper = document.createElement("div");
          loadingWrapper.id = "loading-indicator";
          loadingWrapper.className = "flex mb-4 justify-start";
          loadingWrapper.innerHTML = `
                    <div class="max-w-lg px-4 py-3 rounded-2xl bg-slate-200 text-slate-800 flex items-center space-x-2">
                        <div class="typing-indicator flex space-x-1">
                            <div class="w-2 h-2 bg-slate-500 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-slate-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-slate-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                        <span class="text-sm">🤖 AI thinking with auto-insights...</span>
                    </div>
                `;
          ui.chatContainer.appendChild(loadingWrapper);
          ui.chatContainer.scrollTop = ui.chatContainer.scrollHeight;
        }
      }

      function createPlainTextFallback(cardPayload) {
        const subject =
          cardPayload.body.find((item) => item.size === "Large")?.text ||
          "Meeting";
        const time =
          cardPayload.body.find((item) => item.spacing === "Small")?.text ||
          "Time not specified";
        const joinUrl =
          cardPayload.actions?.find((action) => action.title === "Join Meeting")
            ?.url || "#";
        return `✅ Smart Meeting Created: "${subject}"\n${time}\nJoin Link: ${joinUrl}\n🤖 Auto-insights enabled!`;
      }

      async function addMessage(content, sender, type = "text") {
        const messageWrapper = document.createElement("div");
        messageWrapper.className = `flex mb-4 ${
          sender === "user" ? "justify-end" : "justify-start"
        }`;
        const messageContent = document.createElement("div");
        messageWrapper.appendChild(messageContent);
        ui.chatContainer.appendChild(messageWrapper);

        if (type === "card" && sender === "bot") {
          messageContent.className = "max-w-lg lg:max-w-xl";
          try {
            await waitForAdaptiveCards();
            const adaptiveCard = new AdaptiveCards.AdaptiveCard();
            adaptiveCard.hostConfig = new AdaptiveCards.HostConfig({
              fontFamily: "Inter, sans-serif",
            });
            adaptiveCard.parse(content);
            const renderedCard = adaptiveCard.render();
            renderedCard.classList.add("adaptive-card");
            messageContent.appendChild(renderedCard);
          } catch (error) {
            console.error("Adaptive Card rendering failed:", error);
            messageContent.className =
              "max-w-lg lg:max-w-xl px-4 py-3 rounded-2xl bg-slate-200 text-slate-800 whitespace-pre-wrap";
            messageContent.textContent = createPlainTextFallback(content);
          }
        } else {
          messageContent.className = `max-w-lg lg:max-w-xl px-4 py-3 rounded-2xl ${
            sender === "user"
              ? "bg-gradient-to-r from-blue-500 to-purple-600 text-white"
              : "bg-slate-200 text-slate-800"
          }`;
          if (typeof content === "object") {
            messageContent.textContent = createPlainTextFallback(content);
          } else {
            // Handle markdown-style formatting
            const formattedContent = content
              .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
              .replace(/\n/g, "<br>");
            messageContent.innerHTML = formattedContent;
          }
        }
        ui.chatContainer.scrollTop = ui.chatContainer.scrollHeight;
      }

      function waitForAdaptiveCards() {
        return new Promise((resolve, reject) => {
          let retries = 0;
          const maxRetries = 40;
          const interval = setInterval(() => {
            if (window.AdaptiveCards && window.AdaptiveCards.AdaptiveCard) {
              clearInterval(interval);
              resolve();
            } else {
              retries++;
              if (retries > maxRetries) {
                clearInterval(interval);
                reject(new Error("Adaptive Cards library failed to load."));
              }
            }
          }, 250);
        });
      }

      // 🆕 ENHANCED: Meeting card with auto-insights indicators
      function createEnhancedMeetingCard(meeting, userResolution) {
        const attendeesText = userResolution
          ? `${userResolution.usersResolved}/${userResolution.namesRequested} resolved`
          : `${meeting.attendees?.length || 0} attendees`;

        return {
          type: "AdaptiveCard",
          version: "1.4",
          body: [
            {
              type: "TextBlock",
              text: "✅ Smart Meeting Created with Auto-Insights!",
              weight: "Bolder",
              size: "Medium",
              color: "Good",
            },
            {
              type: "TextBlock",
              text: meeting.subject,
              weight: "Bolder",
              size: "Large",
              wrap: true,
            },
            {
              type: "TextBlock",
              text: `🤖 Scheduled for ${new Date(
                meeting.startTime
              ).toLocaleString()} with AI monitoring`,
              spacing: "Small",
              wrap: true,
            },
            {
              type: "FactSet",
              spacing: "Medium",
              facts: [
                { title: "👥 Attendees:", value: attendeesText },
                {
                  title: "🤖 Auto-Insights:",
                  value: "✅ ENABLED",
                },
                {
                  title: "📧 Live Alerts:",
                  value: userResolution?.messagesSent
                    ? `${userResolution.messagesSent} sent`
                    : "Ready",
                },
                {
                  title: "🔍 AI Features:",
                  value: "Action items, Decisions, Analytics",
                },
              ],
            },
            {
              type: "TextBlock",
              text: "💡 **Auto-Insights Features:**\n• Real-time action item detection\n• Live decision tracking\n• Automatic email notifications\n• Comprehensive final summary",
              wrap: true,
              spacing: "Medium",
              color: "Accent",
            },
          ],
          actions: [
            {
              type: "Action.OpenUrl",
              title: "🔗 Join Smart Meeting",
              url: meeting.joinUrl || "#",
              style: "positive",
            },
            {
              type: "Action.OpenUrl",
              title: "📅 View in Calendar",
              url: meeting.webUrl || "#",
            },
          ],
        };
      }

      async function checkApiStatus() {
        try {
          const response = await fetch(`${API_BASE_URL}/meetings/status`);
          if (!response.ok) throw new Error("API not responding");

          const status = await response.json();

          ui.apiStatusIndicator.classList.remove(
            "bg-yellow-400",
            "animate-pulse"
          );
          ui.apiStatusIndicator.classList.add("bg-green-500");
          ui.apiStatusText.textContent = "Connected";
          ui.messageInput.disabled = false;
          ui.sendButton.disabled = false;

          const welcomeMsg = `Hi! I'm **Agent 365**, your AI meeting assistant with **AUTO-INSIGHTS**! 🚀

**🤖 NEW: Auto-Insights Features:**
🎯 Real-time action item detection and alerts
📊 Live meeting analytics and insights  
💬 Smart decision tracking and notifications
📧 Automatic email updates to attendees
📋 Comprehensive meeting summaries

**What I can do:**
🗓️ Create smart meetings with auto-insights enabled
👥 Find people in your organization
📨 Send messages to colleagues  
🤖 Join meetings for live monitoring
📈 Generate detailed meeting analytics

**Teams Status:** ${
            status.services.teams.available ? "🟢 Connected" : "⚠️ Limited"
          }
**AI Status:** ${status.services.ai.available ? "🟢 Active" : "⚠️ Limited"}
**Auto-Insights:** 🟢 Ready

Try saying: *"Create a smart meeting with John tomorrow at 2pm"* or *"Join agent to my current meeting"*`;

          addMessage(welcomeMsg, "bot");
        } catch (error) {
          ui.apiStatusIndicator.classList.remove(
            "bg-yellow-400",
            "animate-pulse"
          );
          ui.apiStatusIndicator.classList.add("bg-red-500");
          ui.apiStatusText.textContent = "Disconnected";
          addMessage(
            "❌ Could not connect to the backend API. Please make sure the server is running on http://localhost:5000",
            "bot"
          );
        }
      }

      // Event Listeners
      ui.chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const message = ui.messageInput.value.trim();
        if (message) {
          handleUserMessage(message);
          ui.messageInput.value = "";
        }
      });

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        checkApiStatus();
      });
    </script>
  </body>
</html>
